{% extends "layout.html" %}
{% block stylesheet %}
<link rel="stylesheet" href="/static/room.css">
{% endblock %}
{% block content %}

<script>
    setInterval(() => {
        url = '/room/{{room_name | urlencode}}/room_data';
        fetch(url, { method: 'GET' })
            .then((response) => response.json())
            .then((roomData) => {
                console.log(roomData);
                var round_in_progress = "{{round_in_progress}}"
                round_in_progress = round_in_progress == "True" ? true : false
                if (round_in_progress != roomData.round_in_progress || "{{word_count}}" > roomData.word_count) {
                    window.location = window.location.href;
                }

                // Update table
                if ("{{not in_game}}" == "True") {
                    document.getElementById("word_count").innerHTML = roomData.word_count;
                }
                if ("{{round_in_progress}}" == "True") {
                    document.getElementById("seen_count").innerHTML = roomData.seen_count;
                    document.getElementById("card_count").innerHTML = roomData.card_count;
                } else {
                    document.getElementById("ready_player_count").innerHTML = roomData.ready_player_count;
                }

                // Update join round button
                if ("{{round_in_progress}}" == "False" && "{{word_count}}" == 0
                    && roomData.word_count > 0) {
                    document.getElementById("no_words").disabled = false
                    document.getElementById("no_words").value = "Liity seuraavaan kierrokseen"
                }

                // Update start round button
                if ("{{round_in_progress}}" == "False" && "{{session.username == config.admin_username}}" == "True") {
                    if (roomData.word_count > 0 && roomData.ready_player_count >= 2) {
                        document.getElementById("start_round").disabled = false
                    } else {
                        document.getElementById("start_round").disabled = true
                    }
                }
            });
    }, 2000);
</script>

<h1>{{room_name}}</h1>
<div class="table-container">
    <table>
        <tbody>
            {% if not in_game %}
            <tr>
                <td>Sanojen määrä</td>
                <td id="word_count">{{word_count}}</td>
            </tr>
            {% endif %}

            {% if round_in_progress %}
            <tr>
                <td>Aloittaja</td>
                <td>{{config.starter_username}}</td>
            </tr>
            <tr>
                <td>Lapun lukeneet</td>
                <td id="seen_count">{{seen_count}}</td>
            </tr>
            <tr>
                <td>Pelaajien määrä</td>
                <td id="card_count">{{card_count}}</td>
            </tr>
            {% else %}
            <tr>
                <td>Valmiiden pelaajien määrä</td>
                <td id="ready_player_count">{{ready_player_count}}</td>
            </tr>
            {% endif %}

            <tr>
                <td>Edellinen sana</td>
                {% if config.previous_word %}
                <td>{{config.previous_word}}</td>
                {% else %}
                <td></td>
                {% endif %}
            </tr>
        </tbody>
    </table>
</div>

{% if round_in_progress %}
<form class="main-action" action="/room/{{room_name | urlencode}}/word">
    {% if in_game and not seen %}
    <input type="submit" value="Katso uusi lappu" />
    {% elif in_game %}
    <input type="submit" value="Katso lappusi" />
    {% else %}
    <input type="submit" disabled value="Et ole kierroksella mukana" />
    {% endif %}
</form>
{% else %}
<form class="main-action" method="post">
    {% if word_count == 0 %}
    <input id="no_words" type="submit" name="be_ready" value="Sanoja ei ole" disabled />
    {% elif not ready %}
    <input type="submit" name="be_ready" value="Liity seuraavaan kierrokseen" />
    {% else %}
    <input class="red" type="submit" name="unbe_ready" value="Poistu seuraavaasta kierroksesta" />
    {% endif %}
</form>
{% endif %}

<br />
<form method="post">
    <label for="word">Lisää sana:</label>
    <br />
    <div class="input-container">
        <input id="word" type="text" name="word" placeholder="Sana" />
        <input type="submit" value="Lisää" />
    </div>
</form>


<!-- Admin area / button to get admin -->
{% if session.username != config.admin_username %}
<br />
{% if config.admin_username %}
Tämänhetkinen GM on <strong>{{config.admin_username}}</strong>
{% else %}
Kukaan ei ole GM
{% endif %}
<form method="post">
    <input name="be_admin" type="submit" value="Ole GM" />
</form>
{% else %}
<h2 style="margin-bottom: 10px">GMAlue</h2>

{% if session.confirm %}
<div class="confirm">
    <p>{{session.confirm_message}}</p>
    <form method="post">
        <div class="confirm-buttons">
            <input type="submit" class="red" name="confirm" value="Varmista" />
            <input type="submit" name="cancel" value="Peruuta" />
        </div>
    </form>
</div>
<br />
{% endif %}

<form method="post">
    {% if round_in_progress %}
    <input type="submit" name="end_round" value="Lopeta kierros" />
    {% elif word_count > 0 and ready_player_count >= 2 %}
    <input type="submit" id="start_round" name="start_round" value="Aloita kierros" />
    {% else %}
    <input type="submit" id="start_round" name="start_round" value="Aloita kierros" disabled />
    {% endif %}

    <input name="unbe_admin" type="submit" value="Älä ole GM" />
    <input type="submit" name="reset_room" class="red" value="NOLLAA HUONE" />
    <input name="delete_room" type="submit" class="red" value="POISTA HUONE" />
</form>
{% endif %}

{% endblock %}